FungalTree
==========

FungalTree is a WDL-based pipeline for variant calling and phylogenetic analysis in fungal haploid genomes. It uses a reference GenBank file and aligned BAM files to generate filtered variant calls and a maximum-likelihood phylogenetic tree via IQ-TREE2.

Overview
--------

This workflow combines multiple tools to perform:

1.  Reference preparation from GenBank format
2.  Variant calling with GATK3
3.  Conversion of VCF to multi-sequence alignment FASTA
4.  Phylogenetic tree construction using IQ-TREE2

Dependencies
------------

FungalTree imports the FungalVariantCallingGatk3 workflow from the Broad Institute's fungal-wdl repository:

```
https://github.com/broadinstitute/fungal-wdl/blob/master/gatk3/workflows/fungal_variant_calling_gatk3.wdl

```

Modification to FungalVariantCallingGatk3
-----------------------------------------

The original FungalVariantCallingGatk3 workflow includes alignment steps. In this adaptation, the workflow has been modified to:

-   Skip the BWA alignment steps that were present in the original workflow
-   Begin directly from pre-aligned BAM files
-   Keep the variant calling and filtering functionality intact

This modification improves efficiency when working with already aligned BAM files and focuses the workflow on variant calling and downstream analysis.

Workflow Components
-------------------

1.  **GbffToFasta**: Converts GenBank file to FASTA format for use as reference
2.  **GenerateRefFiles**: Creates necessary reference indices and dictionary files
3.  **FungalVariantCallingGatk3**: Performs variant calling and filtering (using modified imported workflow)
4.  **VCFToFasta**: Converts variant calls to a multi-sequence alignment FASTA
5.  **IqTree2**: Generates a maximum likelihood phylogenetic tree

Inputs
------

### FungalTree Workflow Inputs

| Input | Type | Description | Default |
| --- | --- | --- | --- |
| analysis_name | String | Name for the analysis run |  |
| ref_gbff | File | Reference genome in GenBank format |  |
| input_samples | Array[String] | Sample names |  |
| input_bams | Array[File] | Pre-aligned BAM files |  |
| snp_filter_expr | String | GATK expression for SNP hard filtering |  |
| indel_filter_expr | String | GATK expression for INDEL hard filtering |  |
| iqtree2_model | String? | Substitution model for IQ-TREE2 | Optional |
| iqtree2_bootstraps | Int | Number of ultrafast bootstrap replicates | 1000 |
| alrt | Int | SH-like approximate likelihood ratio test replicates | 1000 |
| iqtree2_opts | String? | Additional IQ-TREE2 parameters | Optional |

### FungalVariantCallingGatk3 Inputs (as used in this workflow)

| Input | Type | Description |
| --- | --- | --- |
| analysis_name | String | Name for the analysis run |
| input_samples | Array[String] | Sample names |
| input_bams | Array[File] | Pre-aligned BAM files |
| reference_fasta | File | Reference genome in FASTA format |
| ref_dict | File | Reference sequence dictionary |
| ref_index | File | Reference FASTA index |
| snp_filter_expr | String | GATK expression for SNP hard filtering |
| indel_filter_expr | String | GATK expression for INDEL hard filtering |

Outputs
-------

### FungalTree Workflow Outputs

| Output | Type | Description |
| --- | --- | --- |
| hard_filtered_gvcf | File | Filtered variant calls in gVCF format |
| IqTree2_ml_tree | File | Maximum likelihood phylogenetic tree in Newick format |
| IqTree2_run_date | String | Date when IQ-TREE2 was run |
| IqTree2_model_used | String | Substitution model used by IQ-TREE2 |

### FungalVariantCallingGatk3 Outputs (as used by FungalTree)

| Output | Type | Description |
| --- | --- | --- |
| hard_filtered_gvcf | File | Filtered variant calls in gVCF format |

## Task Descriptions and Enhancements

### Task: [GbffToFasta]()

**Purpose:**
Convert a GenBank-format reference file to a FASTA format for downstream processing.

**Inputs:**
- `ref_gbff`: Reference file in GenBank (.gbff) format.

**Outputs:**
- `reference_fasta`: Reference genome in FASTA format.


### Task: [GenerateRefFiles]()

**Purpose:**
This task prepares all required reference genome index files needed for downstream tools including BWA, Samtools, and Picard.

**Inputs:**
- `ref_fasta`: Reference genome in FASTA format
- `input_bam`: Aligned bam file

**Outputs:**
- `ref_sa`: BWA suffix array index (.sa)
- `ref_bwt`: BWA Burrows-Wheeler Transform (.bwt)
- `ref_amb`: BWA ambiguity file (.amb)
- `ref_ann`: BWA annotation file (.ann)
- `ref_pac`: BWA packed sequence (.pac)
- `ref_dict`: Sequence dictionary (.dict) generated by Picard
- `ref_index`: FASTA index file (.fai) generated by Samtools
- `reference_fasta`: The input reference genome


### Task: [VCFToFasta]()

**Purpose:**
This task converts a multi-sample VCF file into a multiple sequence alignment (MSA) FASTA format suitable for phylogenetic analysis.

**Inputs:**
- `vcf_file`: A gzipped multi-sample VCF file (.vcf.gz)

**Outputs:**
- `alignmnent_fasta`: MSA FASTA file containing genotype-based sequences per sample. The .min4.fasta suffix indicates a minimum of 4 alleles per site retained (as per the scriptâ€™s default filtering behavior).



### Task: [IqTree2]()

**Purpose:**
Constructs a robust phylogenetic tree from aligned variant sequences with statistical support values, forming the final output of the variant-to-tree workflow.

**Inputs:**
- `alignment`: FASTA file with aligned sequences (e.g. output from VCFToFasta)
- `cluster_name`: Prefix for output tree filename
- `iqtree2_model`:  Optional string. Substitution model to use. If not provided, IQ-TREE's ModelFinder will determine the best-fit model.
- `iqtree2_bootstraps`: Number of ultrafast bootstrap replicates (default = 1000)
- `alrt`: Number of SH-like approximate likelihood ratio test replicates (default = 1000)
- `iqtree2_opts`: Optional String. User-supplied options for IQ-TREE2

**Outputs:**
- `ml_tree`: Newick file containing the final phylogenetic tree (*_iqtree.nwk)
- `iqtree2_model_used`: Substitution model used (either user-specified or inferred by ModelFinder)
- `iqtree2_version`: IQ-TREE2 version string
- `date`: Timestamp of the run





Additional Notes
----------------

-   The workflow requires at least 4 samples to successfully run the phylogenetic tree analysis.
-   IQ-TREE2 can automatically select an appropriate substitution model if none is specified.
-   Common substitution models used with similar tools include:
    -   HKY (Bactopia)
    -   GTR+F+I (Grandeur)
    -   GTR+G4 (Nullarbor)
    -   GTR+G (Dryad)